<!DOCTYPE html>

<html>
<head>
  <title>pace.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>pace.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>defaultOptions =</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>How long should it take for the bar to animate to a new
point after receiving it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  catchupTime: <span class="number">500</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>How quickly should the bar be moving before it has any progress
info from a new source in %/ms</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialRate: <span class="number">.03</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>What is the minimum amount of time the bar should be on the
screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  minTime: <span class="number">500</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>What is the minimum amount of time the bar should sit after the last
update before disappearing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ghostTime: <span class="number">250</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Its easy for a bunch of the bar to be eaten in the first few frames
before we know how much there is to load.  This limits how much of
the bar can be used per frame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  maxProgressPerFrame: <span class="number">10</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>This tweaks the animation easing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  easeFactor: <span class="number">1.25</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Should pace automatically start when the page is loaded, or should it wait for <code>start</code> to
be called?  Always false if pace is loaded with AMD or CommonJS.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  startOnPageLoad: <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Should we restart the browser when pushState or replaceState is called?  (Generally
means ajax navigation has occured)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  restartOnPushState: <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Should pace automatically restart when a Backbone route change occurs?  Can also be an
array of route names.  Ignored if Backbone.js is not included on the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  restartOnBackboneRoute: <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>What element should the pace element be appended to on the page?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  target: <span class="string">'body'</span>

  elements:</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>How frequently in ms should we check for the elements being tested for
using the element monitor?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    checkInterval: <span class="number">100</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>What elements should we wait for before deciding the page is fully loaded (not required)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    selectors: [<span class="string">'body'</span>]
    
  eventLag:</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>When we first start measuring event lag, not much is going on in the browser yet, so it&#39;s
not uncommon for the numbers to be abnormally low for the first few samples.  This configures
how many samples we need before we consider a low number to mean completion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    minSamples: <span class="number">10</span>

  ajax:</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Which HTTP methods should we track?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    trackMethods: [<span class="string">'GET'</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Should we track web socket connections?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    trackWebSockets: true

now = -&gt;
  performance?.now?() ? +new Date

requestAnimationFrame = window.requestAnimationFrame or window.mozRequestAnimationFrame or
                        window.webkitRequestAnimationFrame or window.msRequestAnimationFrame

cancelAnimationFrame = window.cancelAnimationFrame or window.mozCancelAnimationFrame

if not requestAnimationFrame?
  requestAnimationFrame = (fn) -&gt;
    setTimeout fn, 50

  cancelAnimationFrame = (id) -&gt;
    clearTimeout id

runAnimation = (fn) -&gt;
  last = now()
  tick = -&gt;
    diff = now() - last
    last = now()

    fn diff, -&gt;
      requestAnimationFrame tick

  tick()

result = (obj, key, args...) -&gt;
  if typeof obj[key] is 'function'
    obj[key](args...)
  else
    obj[key]

extend = (out, sources...) -&gt;
  for source in sources when source
    for own key, val of source
      if out[key]? and typeof out[key] is 'object' and val? and typeof val is 'object'
        extend(out[key], val)
      else
        out[key] = val
  out

getFromDOM = (key='options', json=true) -&gt;
  el = document.querySelector "[data-pace-#{ key }]"

  return unless el

  data = el.getAttribute "data-pace-#{ key }"
  
  return data if not json

  try
    return JSON.parse data
  catch e
    console?.error "Error parsing inline pace options", e

window.Pace ?= {}

options = Pace.options = extend defaultOptions, window.paceOptions, getFromDOM()

class Bar
  constructor: -&gt;
    @progress = 0

  getElement: -&gt;
    if not @el?
      @el = document.createElement 'div'
      @el.className = "pace pace-active"

      @el.innerHTML = '''
      &lt;div class="pace-progress"&gt;
        &lt;div class="pace-progress-inner"&gt;&lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="pace-activity"&gt;&lt;/div&gt;
      '''
      targetElement = document.querySelector options.target
      if targetElement.firstChild?
        targetElement.insertBefore @el, targetElement.firstChild
      else
        targetElement.appendChild @el

    @el

  finish: -&gt;
    el = @getElement()

    el.className = el.className.replace 'pace-active', ''
    el.className += ' pace-inactive'

  update: (prog) -&gt;
    @progress = prog

    do @render

  destroy: -&gt;
    @getElement().parentNode.removeChild(@getElement())

    @el = undefined

  render: -&gt;
    if not document.querySelector(options.target)?
      return false

    el = @getElement()
      
    el.children[0].style.width = "#{ @progress }%"

    if not @lastRenderedProgress or @lastRenderedProgress|0 != @progress|0</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>The whole-part of the number has changed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      
      el.setAttribute <span class="string">'data-progress-text'</span>, <span class="string">"<span class="subst">#{ @progress|<span class="number">0</span> }</span>%"</span>

      <span class="keyword">if</span> <span class="property">@progress</span> &gt;= <span class="number">100</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>We cap it at 99 so we can use prefix-based attribute selectors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        progressStr = <span class="string">'99'</span>
      <span class="keyword">else</span>
        progressStr = <span class="keyword">if</span> <span class="property">@progress</span> &lt; <span class="number">10</span> <span class="keyword">then</span> <span class="string">"0"</span> <span class="keyword">else</span> <span class="string">""</span>
        progressStr += <span class="property">@progress</span>|<span class="number">0</span>

      el.setAttribute <span class="string">'data-progress'</span>, <span class="string">"<span class="subst">#{ progressStr }</span>"</span>

    <span class="property">@lastRenderedProgress</span> = <span class="property">@progress</span>

  done: -&gt;
    <span class="property">@progress</span> &gt;= <span class="number">100</span>

<span class="class"><span class="keyword">class</span> <span class="title">Events</span></span>
  constructor: -&gt;
    <span class="property">@bindings</span> = {}

  trigger: (name, val) -&gt;
    <span class="keyword">if</span> <span class="property">@bindings</span>[name]?
      <span class="keyword">for</span> binding <span class="keyword">in</span> <span class="property">@bindings</span>[name]
        binding.call @, val

  <span class="literal">on</span>: (name, fn) -&gt;
    <span class="property">@bindings</span>[name] ?= []
    <span class="property">@bindings</span>[name].push fn

_XMLHttpRequest = window.XMLHttpRequest
_XDomainRequest = window.XDomainRequest
_WebSocket = window.WebSocket

<span class="function"><span class="title">extendNative</span></span> = (to, from) -&gt;
  <span class="keyword">for</span> key <span class="keyword">of</span> from::
    <span class="keyword">try</span>
      val = from::[key]

      <span class="keyword">if</span> <span class="keyword">not</span> to[key]? <span class="keyword">and</span> <span class="keyword">typeof</span> val <span class="keyword">isnt</span> <span class="string">'function'</span>
        to[key] = val
    <span class="keyword">catch</span> e</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>We should only ever instantiate one of these</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">RequestIntercept</span> <span class="keyword">extends</span> <span class="title">Events</span></span>
  constructor: -&gt;
    <span class="keyword">super</span>

    <span class="function"><span class="title">monitorXHR</span></span> = (req) =&gt;
      _open = req.open
      req.<span class="function"><span class="title">open</span></span> = (type, url, async) =&gt;
        <span class="keyword">if</span> (type ? <span class="string">'GET'</span>).toUpperCase() <span class="keyword">in</span> options.ajax.trackMethods
          <span class="property">@trigger</span> <span class="string">'request'</span>, {type, url, request: req}

        _open.apply req, arguments

    window.<span class="function"><span class="title">XMLHttpRequest</span></span> = (flags) -&gt;
      req = <span class="keyword">new</span> _XMLHttpRequest(flags)

      monitorXHR req

      req

    extendNative window.XMLHttpRequest, _XMLHttpRequest

    <span class="keyword">if</span> _XDomainRequest?
      window.<span class="function"><span class="title">XDomainRequest</span></span> = -&gt;
        req = <span class="keyword">new</span> _XDomainRequest

        monitorXHR req

        req

      extendNative window.XDomainRequest, _XDomainRequest

    <span class="keyword">if</span> _WebSocket? <span class="keyword">and</span> options.ajax.trackWebSockets
      window.<span class="function"><span class="title">WebSocket</span></span> = (url, protocols) =&gt;
        req = <span class="keyword">new</span> _WebSocket(url, protocols)

        <span class="property">@trigger</span> <span class="string">'request'</span>, {type: <span class="string">'socket'</span>, url, protocols, request: req}

        req

      extendNative window.WebSocket, _WebSocket

intercept = <span class="keyword">new</span> RequestIntercept

<span class="class"><span class="keyword">class</span> <span class="title">AjaxMonitor</span></span>
  constructor: -&gt;
    <span class="property">@elements</span> = []

    intercept.<span class="literal">on</span> <span class="string">'request'</span>, =&gt; <span class="property">@watch</span> arguments...

  watch: ({type, request}) -&gt;
    <span class="keyword">if</span> type <span class="keyword">is</span> <span class="string">'socket'</span>
      tracker = <span class="keyword">new</span> SocketRequestTracker(request)
    <span class="keyword">else</span>
      tracker = <span class="keyword">new</span> XHRRequestTracker(request)

    <span class="property">@elements</span>.push tracker

<span class="class"><span class="keyword">class</span> <span class="title">XHRRequestTracker</span></span>
  constructor: (request) -&gt;
    <span class="property">@progress</span> = <span class="number">0</span>

    <span class="keyword">if</span> window.ProgressEvent?</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>We&#39;re dealing with a modern browser with progress event support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      size = <span class="literal">null</span>
      request.addEventListener <span class="string">'progress'</span>, (evt) =&gt;
        <span class="keyword">if</span> evt.lengthComputable
          <span class="property">@progress</span> = <span class="number">100</span> * evt.loaded / evt.total
        <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If it&#39;s chunked encoding, we have no way of knowing the total length of the
response, all we can do is increment the progress with backoff such that we
never hit 100% until it&#39;s done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="property">@progress</span> = <span class="property">@progress</span> + (<span class="number">100</span> - <span class="property">@progress</span>) / <span class="number">2</span>

      <span class="keyword">for</span> event <span class="keyword">in</span> [<span class="string">'load'</span>, <span class="string">'abort'</span>, <span class="string">'timeout'</span>, <span class="string">'error'</span>]
        request.addEventListener event, =&gt;
          <span class="property">@progress</span> = <span class="number">100</span>

    <span class="keyword">else</span>
      _onreadystatechange = request.onreadystatechange
      request.<span class="function"><span class="title">onreadystatechange</span></span> = =&gt;
        <span class="keyword">if</span> request.readyState <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">4</span>]
          <span class="property">@progress</span> = <span class="number">100</span>
        <span class="keyword">else</span> <span class="keyword">if</span> request.readyState <span class="keyword">is</span> <span class="number">3</span>
          <span class="property">@progress</span> = <span class="number">50</span>

        _onreadystatechange?(arguments...)

<span class="class"><span class="keyword">class</span> <span class="title">SocketRequestTracker</span></span>
  constructor: (request) -&gt;
    <span class="property">@progress</span> = <span class="number">0</span>

    <span class="keyword">for</span> event <span class="keyword">in</span> [<span class="string">'error'</span>, <span class="string">'open'</span>]
      request.addEventListener event, =&gt;
        <span class="property">@progress</span> = <span class="number">100</span>

<span class="class"><span class="keyword">class</span> <span class="title">ElementMonitor</span></span>
  constructor: (options={}) -&gt;
    <span class="property">@elements</span> = []

    options.selectors ?= []
    <span class="keyword">for</span> selector <span class="keyword">in</span> options.selectors
      <span class="property">@elements</span>.push <span class="keyword">new</span> ElementTracker selector
    
<span class="class"><span class="keyword">class</span> <span class="title">ElementTracker</span></span>
  constructor: (<span class="property">@selector</span>) -&gt;
    <span class="property">@progress</span> = <span class="number">0</span>

    <span class="property">@check</span>()

  check: -&gt;
    <span class="keyword">if</span> document.querySelector(<span class="property">@selector</span>)
      <span class="property">@done</span>()
    <span class="keyword">else</span>
      setTimeout (=&gt; <span class="property">@check</span>()),
        options.elements.checkInterval

  done: -&gt;
    <span class="property">@progress</span> = <span class="number">100</span>

<span class="class"><span class="keyword">class</span> <span class="title">DocumentMonitor</span></span>
  states:
    loading: <span class="number">0</span>
    interactive: <span class="number">50</span>
    complete: <span class="number">100</span>

  constructor: -&gt;
    <span class="property">@progress</span> = <span class="property">@states</span>[document.readyState] ? <span class="number">100</span>

    _onreadystatechange = document.onreadystatechange
    document.<span class="function"><span class="title">onreadystatechange</span></span> = =&gt;
      <span class="keyword">if</span> <span class="property">@states</span>[document.readyState]?
        <span class="property">@progress</span> = <span class="property">@states</span>[document.readyState]

      _onreadystatechange?(arguments...)

<span class="class"><span class="keyword">class</span> <span class="title">EventLagMonitor</span></span>
  constructor: -&gt;
    <span class="property">@progress</span> = <span class="number">0</span>

    avg = <span class="number">0</span>

    points = <span class="number">0</span>
    last = now()
    setInterval =&gt;
      diff = now() - last - <span class="number">50</span>
      last = now()

      avg = avg + (diff - avg)/<span class="number">15</span>

      <span class="keyword">if</span> points++ &gt; options.eventLag.minSamples <span class="keyword">and</span> Math.abs(avg) &lt; <span class="number">3</span>
        avg = <span class="number">0</span>

      <span class="property">@progress</span> = <span class="number">100</span> * (<span class="number">3</span> / (avg + <span class="number">3</span>))
    , <span class="number">50</span>

<span class="class"><span class="keyword">class</span> <span class="title">Scaler</span></span>
  constructor: (<span class="property">@source</span>) -&gt;
    <span class="property">@last</span> = <span class="property">@sinceLastUpdate</span> = <span class="number">0</span>
    <span class="property">@rate</span> = options.initialRate
    <span class="property">@catchup</span> = <span class="number">0</span>
    <span class="property">@progress</span> = <span class="property">@lastProgress</span> = <span class="number">0</span>

    <span class="keyword">if</span> <span class="property">@source</span>?
      <span class="property">@progress</span> = result(<span class="property">@source</span>, <span class="string">'progress'</span>)

  tick: (frameTime, val) -&gt;
    val ?= result(<span class="property">@source</span>, <span class="string">'progress'</span>)

    <span class="keyword">if</span> val &gt;= <span class="number">100</span>
      <span class="property">@done</span> = <span class="literal">true</span>

    <span class="keyword">if</span> val == <span class="property">@last</span>
      <span class="property">@sinceLastUpdate</span> += frameTime
    <span class="keyword">else</span>
      <span class="keyword">if</span> <span class="property">@sinceLastUpdate</span>
        <span class="property">@rate</span> = (val - <span class="property">@last</span>) / <span class="property">@sinceLastUpdate</span>

      <span class="property">@catchup</span> = (val - <span class="property">@progress</span>) / options.catchupTime

      <span class="property">@sinceLastUpdate</span> = <span class="number">0</span>
      <span class="property">@last</span> = val

    <span class="keyword">if</span> val &gt; <span class="property">@progress</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>After we&#39;ve got a datapoint, we have catchupTime to
get the progress bar to reflect that new data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="property">@progress</span> += <span class="property">@catchup</span> * frameTime

    scaling = (<span class="number">1</span> - Math.pow(<span class="property">@progress</span> / <span class="number">100</span>, options.easeFactor))</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Based on the rate of the last update, we preemptively update
the progress bar, scaling it so it can never hit 100% until we
know it&#39;s done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="property">@progress</span> += scaling * <span class="property">@rate</span> * frameTime

    <span class="property">@progress</span> = Math.min(<span class="property">@lastProgress</span> + options.maxProgressPerFrame, <span class="property">@progress</span>)

    <span class="property">@progress</span> = Math.max(<span class="number">0</span>, <span class="property">@progress</span>)
    <span class="property">@progress</span> = Math.min(<span class="number">100</span>, <span class="property">@progress</span>)

    <span class="property">@lastProgress</span> = <span class="property">@progress</span>

    <span class="property">@progress</span>

sources = <span class="literal">null</span>
scalers = <span class="literal">null</span>
bar = <span class="literal">null</span>
uniScaler = <span class="literal">null</span>
animation = <span class="literal">null</span>
cancelAnimation = <span class="literal">null</span>

<span class="function"><span class="title">handlePushState</span></span> = -&gt;
  <span class="keyword">if</span> options.restartOnPushState
    Pace.restart()</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>We reset the bar whenever it looks like an ajax navigation has occured.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> window.history.pushState?
  _pushState = window.history.pushState
  window.history.<span class="function"><span class="title">pushState</span></span> = -&gt;
    handlePushState()

    _pushState.apply window.history, arguments

<span class="keyword">if</span> window.history.replaceState?
  _replaceState = window.history.replaceState
  window.history.<span class="function"><span class="title">replaceState</span></span> = -&gt;
    handlePushState()

    _replaceState.apply window.history, arguments

firstLoad = <span class="literal">true</span>
<span class="keyword">if</span> options.restartOnBackboneRoute</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Bind in a timeout, as it&#39;s possible Backbone hasen&#39;t been
included yet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setTimeout -&gt;
    <span class="keyword">return</span> <span class="keyword">unless</span> window.Backbone?
   
    Backbone.history.<span class="literal">on</span> <span class="string">'route'</span>, (router, name) -&gt;
      <span class="keyword">return</span> <span class="keyword">unless</span> rule = options.restartOnBackboneRoute

      <span class="keyword">if</span> firstLoad</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>We don&#39;t want to do anything on the initial route</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        firstLoad = <span class="literal">false</span>
        <span class="keyword">return</span>

      <span class="keyword">if</span> <span class="keyword">typeof</span> rule <span class="keyword">is</span> <span class="string">'object'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>It&#39;s an array of route names</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> routeName <span class="keyword">in</span> rule <span class="keyword">when</span> routeName <span class="keyword">is</span> name
          Pace.restart()
          <span class="keyword">break</span>
      <span class="keyword">else</span>
        Pace.restart()
  , <span class="number">0</span>

SOURCE_KEYS =
  ajax: AjaxMonitor
  elements: ElementMonitor
  document: DocumentMonitor
  eventLag: EventLagMonitor

<span class="keyword">do</span> <span class="function"><span class="title">init</span></span> = -&gt;
  Pace.sources = sources = []

  <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'ajax'</span>, <span class="string">'elements'</span>, <span class="string">'document'</span>, <span class="string">'eventLag'</span>]
    <span class="keyword">if</span> options[type] <span class="keyword">isnt</span> <span class="literal">false</span>
      sources.push <span class="keyword">new</span> SOURCE_KEYS[type](options[type])

  <span class="keyword">for</span> source <span class="keyword">in</span> options.extraSources ? []
    sources.push <span class="keyword">new</span> source(options)

  Pace.bar = bar = <span class="keyword">new</span> Bar</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Each source of progress data has it&#39;s own scaler to smooth its output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  scalers = []</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>We have an extra scaler for the final output to keep things looking nice as we add and
remove sources</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  uniScaler = <span class="keyword">new</span> Scaler

Pace.<span class="function"><span class="title">stop</span></span> = -&gt;
  bar.destroy()</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Not all browsers support cancelAnimationFrame</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cancelAnimation = <span class="literal">true</span>

  <span class="keyword">if</span> animation?
    cancelAnimationFrame? animation
    animation = <span class="literal">null</span>

  init()

Pace.<span class="function"><span class="title">restart</span></span> = -&gt;
  Pace.stop()
  Pace.go()

Pace.<span class="function"><span class="title">go</span></span> = -&gt;
  bar.render()

  cancelAnimation = <span class="literal">false</span>
  animation = runAnimation (frameTime, enqueueNextFrame) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Every source gives us a progress number from 0 - 100
It&#39;s up to us to figure out how to turn that into a smoothly moving bar</p>
<p>Their progress numbers can only increment.  We try to interpolate
between the numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    remaining = <span class="number">100</span> - bar.progress

    count = sum = <span class="number">0</span>
    done = <span class="literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>A source is composed of a bunch of elements, each with a raw, unscaled progress</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">for</span> source, i <span class="keyword">in</span> sources
      scalerList = scalers[i] ?= []

      elements = source.elements ? [source]</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Each element is given it&#39;s own scaler, which turns its value into something
smoothed for display</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> element, j <span class="keyword">in</span> elements
        scaler = scalerList[j] ?= <span class="keyword">new</span> Scaler element

        done &amp;= scaler.done

        <span class="keyword">continue</span> <span class="keyword">if</span> scaler.done

        count++
        sum += scaler.tick(frameTime)

    avg = sum / count

    bar.update uniScaler.tick(frameTime, avg)

    start = now()
    <span class="keyword">if</span> bar.done() <span class="keyword">or</span> done <span class="keyword">or</span> cancelAnimation
      bar.update <span class="number">100</span>

      setTimeout -&gt;
        bar.finish()
      , Math.max(options.ghostTime, Math.min(options.minTime, now() - start))
    <span class="keyword">else</span>
      enqueueNextFrame()

Pace.<span class="function"><span class="title">start</span></span> = (_options) -&gt;
  extend options, _options

  bar.render()</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>It&#39;s usually possible to render a bit before the document declares itself ready</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> <span class="keyword">not</span> document.querySelector(<span class="string">'.pace'</span>)
    setTimeout Pace.start, <span class="number">50</span>
  <span class="keyword">else</span>
    Pace.go()

<span class="keyword">if</span> <span class="keyword">typeof</span> define <span class="keyword">is</span> <span class="string">'function'</span> <span class="keyword">and</span> define.amd</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>AMD</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  define -&gt; Pace
<span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">typeof</span> exports <span class="keyword">is</span> <span class="string">'object'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>CommonJS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  module.exports = Pace
<span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Global</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> options.startOnPageLoad
    Pace.start()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
